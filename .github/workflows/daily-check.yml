name: Daily Health Check + Summary

on:
  schedule:
    # 09:00 Helsinki –∑–∏–º–æ–π ‚âà 07:00 UTC
    - cron: '0 7 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run health check
        id: hc
        shell: bash
        run: |
          set +e
          chmod +x scripts/check-integrity.sh
          bash scripts/check-integrity.sh
          exit_code=$?
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: reports/health-check-*.md
          retention-days: 30
          if-no-files-found: warn

      - name: Create Issue if problems found
        if: ${{ steps.hc.outputs.exit_code != '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const dir = 'reports';
            const files = fs.existsSync(dir) ? fs.readdirSync(dir).filter(f => f.startsWith('health-check-')) : [];
            const latest = files.sort().reverse()[0];
            const body = latest ? fs.readFileSync(`${dir}/${latest}`, 'utf8') : 'Health-check –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–æ –æ—Ç—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã (health-check) ‚Äî ${new Date().toISOString().split('T')[0]}`,
              body,
              labels: ['health-check', '–∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞']
            });

  daily-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect last 24h changes
        shell: bash
        run: |
          mkdir -p .tmp
          git log --since="24 hours ago" --pretty=format:"- %h %ad %an %s" --date=short > .tmp/commits.txt || true
          git diff --since="24 hours ago" > .tmp/diff.patch || true
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          sed -e 's/\r$//' .tmp/commits.txt >> $GITHUB_ENV || true
          echo "EOF" >> $GITHUB_ENV
          echo "DIFF_BYTES=$(wc -c < .tmp/diff.patch | tr -d ' ')" >> $GITHUB_ENV

      - name: Generate summary via LLM
        id: llm
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        shell: bash
        run: |
          python3 - << 'PY'
          import os, json, pathlib, textwrap, datetime, urllib.request

          # --- –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–û–í–ê–ô–î–ï–†–ê ---
          # –ó–¥–µ—Å—å –ø—Ä–∏–º–µ—Ä –ø–æ–¥ OpenAI Responses API.
          # –ï—Å–ª–∏ —É —Ç–µ–±—è Claude ‚Äî —Å–∫–∞–∂–∏, –∏ —è –¥–∞–º –≥–æ—Ç–æ–≤—ã–π –±–ª–æ–∫ –ø–æ–¥ Anthropic.
          api_key = os.environ["LLM_API_KEY"]

          commits = pathlib.Path(".tmp/commits.txt").read_text(encoding="utf-8", errors="ignore")
          diff = pathlib.Path(".tmp/diff.patch").read_text(encoding="utf-8", errors="ignore")

          # –û–≥—Ä–∞–Ω–∏—á–∏–º diff, —á—Ç–æ–±—ã –Ω–µ —É–ª–µ—Ç–µ—Ç—å –≤ –ª–∏–º–∏—Ç—ã
          max_chars = 120_000
          if len(diff) > max_chars:
            diff = diff[:max_chars] + "\n\n[diff truncated]\n"

          today = datetime.date.today().isoformat()

          prompt = f"""
          –¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–æ–µ–∫—Ç–∞ marathon-v2. –°—Ñ–æ—Ä–º–∏—Ä—É–π –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å–≤–æ–¥–∫—É –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞.

          –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–≤–æ–¥–∫–µ:
          1) –ö–æ—Ä–æ—Ç–∫–∏–π –∏—Ç–æ–≥ (3‚Äì6 –ø—É–Ω–∫—Ç–æ–≤)
          2) –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º/–ø–∞–ø–∫–∞–º)
          3) –†–∏—Å–∫–∏/–ø–æ–ª–æ–º–∫–∏ (–µ—Å–ª–∏ –≤–∏–¥–Ω–æ –ø–æ diff)
          4) To-do –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (3‚Äì7 –ø—É–Ω–∫—Ç–æ–≤)
          5) –ï—Å–ª–∏ –∫–æ–º–º–∏—Ç–æ–≤ –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –±—ã–ª–æ.

          –ö–æ–º–º–∏—Ç—ã:
          {commits or "–Ω–µ—Ç"}

          Diff:
          {diff or "–Ω–µ—Ç"}
          """

          # OpenAI Responses API (–ø—Ä–∏–º–µ—Ä)
          url = "https://api.openai.com/v1/responses"
          headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json",
          }
          payload = {
            "model": "gpt-4.1-mini",
            "input": prompt,
          }

          req = urllib.request.Request(url, data=json.dumps(payload).encode("utf-8"), headers=headers, method="POST")
          with urllib.request.urlopen(req, timeout=60) as resp:
            data = json.loads(resp.read().decode("utf-8"))

          # –î–æ—Å—Ç–∞—ë–º —Ç–µ–∫—Å—Ç (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
          text = ""
          for item in data.get("output", []):
            for c in item.get("content", []):
              if c.get("type") == "output_text":
                text += c.get("text", "")
          text = text.strip() or "(LLM –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)"

          out = f"# –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞ ‚Äî {today}\n\n{text}\n"
          pathlib.Path(".tmp/summary.md").write_text(out, encoding="utf-8")
          print("Wrote .tmp/summary.md")
          PY

      - name: Create Issue (daily summary)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('.tmp/summary.md', 'utf8');
            const today = new Date().toISOString().split('T')[0];

            // –ß—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å, –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –ª–∏ —É–∂–µ —Å–≤–æ–¥–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'daily-summary',
              per_page: 50
            });
            const exists = issues.some(i => i.title.includes(today));
            if (!exists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üóìÔ∏è –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞ ‚Äî ${today}`,
                body,
                labels: ['daily-summary', '–∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞']
              });
            } else {
              core.info(`Issue for ${today} already exists, skipping.`);
            }
